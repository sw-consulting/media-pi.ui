# Copyright (c) 2025 sw.consulting
# This file is a part of Media Pi frontend application

map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

upstream cockpit_ws {
  server gateway:9090;   # Cockpit (gateway) container
}

upstream mediapi_core {
  server api:8085;       # media-pi.core (API) container
}

# Derive cockpit alias: prefer header returned by the auth subrequest
# (X-Cockpit-Alias). If the header is empty, fall back to "pi-<deviceId>".
# We use an intermediate variable set by auth_request_set, then map that
# variable to the final $cockpit_alias to avoid using `if` inside the
# `location` block which can cause unexpected behavior.
map $cockpit_alias_header $cockpit_alias {
  default $cockpit_alias_header;
  ""      "pi-$arg_deviceId";
}

# Default server configuration

# Port 8082 behavior is generated at container start by `update-config.sh`.
# The script writes `/etc/nginx/media-pi/port-8082.conf` from the
# `PORTS_LAYOUT` environment variable (debug|release). This file is
# included below so the behavior can be changed without editing this file.
include /etc/nginx/media-pi/port-8082.conf;

server {
  listen 8083 ssl default_server;
  listen [::]:8083 ssl default_server;
  http2 on;

  ssl_certificate /etc/nginx/certificate/s.crt;
  ssl_certificate_key /etc/nginx/certificate/s.key;
  root /var/www;
  index 200.html;
  server_name _;
  error_page 404 404.html;
  location / {
    try_files $uri $uri/ =404;
  }
}

# Virtual Host configuration for media-pi.sw.consulting

server {
  listen 8083 ssl;
  listen [::]:8083 ssl;
  http2 on;
  ssl_certificate /etc/nginx/certificate/s.crt;
  ssl_certificate_key /etc/nginx/certificate/s.key;
  root /var/www/media-pi;
  index index.html;

  server_name media-pi.sw.consulting;

  location / {
    try_files $uri /index.html =404;
  }
}

# Cockpit server configuration is generated at container start as
# /etc/nginx/conf.d/cockpit.conf to allow debug vs release layouts.
include /etc/nginx/media-pi/cockpit.conf;
